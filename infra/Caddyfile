# Global Caddy options (optional)
{
    # E-mail for ACME registration / certificate renewal alerts
    email admin@pr0d.ru
    # Uncomment for verbose logs during debugging
    # debug
}

# Snippet with directives shared across sites
(common) {
    encode zstd gzip
    log {
        output stdout
        format console
    }
}

# ────────────────────────────────────────────────
#  Main site – SPA frontend + API + LiveKit
#  Domain comes from frontend `.env.production`:
#    VITE_API_URL=https://shpion.pr0d.ru
#    VITE_LIVEKIT_URL=wss://shpion.pr0d.ru/livekit
#  ────────────────────────────────────────────────
shpion.pr0d.ru, www.pr0d.ru {
    import common

    # --- Backend API (Express + Socket.io) ---
    @api path /api/*
    reverse_proxy @api backend:3001

    # --- LiveKit signalling ---
    # Strip /livekit prefix automatically to match LK root path
    handle_path /livekit/* {
        reverse_proxy localhost:7880
    }

    # --- Frontend SPA ---
    # Everything else goes to the Vite-built React app served by Nginx (port 8080).
    handle {
        reverse_proxy frontend:8080
    }
} 